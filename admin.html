<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobster Shack Bali - Admin Panel</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* --- Variabel CSS dari Situs Utama (Dipertahankan untuk Konsistensi) --- */
        :root {
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Poppins', sans-serif;
            --color-primary: #D84B42; /* Merah Lobster */
            --color-secondary: #2D4C5E; /* Biru Gelap / Abu-abu Kebiruan */
            --color-background: #F8F6F0; /* Krem Muda */
            --color-surface: #FFFFFF; /* Putih Bersih */
            --color-text: #333333; /* Hitam Pekat */
            --color-text-light: #6c757d; /* Abu-abu Teks */
            --color-border: #E0DACE; /* Garis Krem */
            --shadow-sm: 0 2px 8px rgba(45, 76, 94, .07);
            --shadow-md: 0 4px 15px rgba(45, 76, 94, .12);
            --shadow-lg: 0 8px 30px rgba(45, 76, 94, .2);
            --border-radius: 12px;
            --transition-speed: .4s;
        }

        /* --- Global Admin Styles --- */
        body {
            font-family: var(--font-body);
            display: flex; /* Menggunakan flexbox untuk layout sidebar-content */
            min-height: 100vh;
            margin: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* --- Login Page Styles --- */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--color-background);
            position: fixed; /* Penting agar tidak terganggu oleh panel admin di bawahnya */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000; /* Pastikan selalu di atas */
        }
        #login-form-container {
            background: var(--color-surface);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        #login-form-container .logo {
            height: 80px;
            margin-bottom: 2rem;
        }
        #login-form-container h2 {
            font-family: var(--font-heading);
            color: var(--color-secondary);
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }
        #login-form .form-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }
        #login-form .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: .5rem;
            color: var(--color-secondary);
        }
        #login-form .form-group input {
            width: 100%;
            padding: .8rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #login-form .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(216, 75, 66, 0.2);
        }
        #login-form button.btn {
            width: 100%;
            margin-top: 1.5rem;
        }
        #login-error-message {
            color: var(--color-primary);
            margin-top: 1rem;
            font-weight: 500;
        }

        /* --- Layout Admin Panel --- */
        #admin-panel-container {
            display: flex;
            width: 100%;
            /* Sembunyikan secara default, hanya ditampilkan setelah login */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        #admin-panel-container.visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }

        #admin-sidebar {
            width: 280px; /* Lebih lebar sedikit untuk kenyamanan */
            background-color: var(--color-secondary);
            color: rgba(255, 255, 255, 0.9);
            padding: 25px 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 999;
        }
        #admin-sidebar .logo {
            height: 70px;
            filter: brightness(0) invert(1); /* Untuk logo putih di latar belakang gelap */
            margin-bottom: 30px;
            display: block; /* Agar margin-bottom bekerja */
            text-align: center; /* Untuk menengahkan logo jika lebih kecil dari lebar sidebar */
        }
        #admin-sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #admin-sidebar nav ul li {
            margin-bottom: 8px;
        }
        #admin-sidebar nav ul li a,
        #admin-sidebar #logout-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            font-weight: 500;
            background: none; /* Untuk tombol logout */
            border: none; /* Untuk tombol logout */
            width: 100%; /* Untuk tombol logout */
            text-align: left; /* Untuk tombol logout */
            cursor: pointer; /* Untuk tombol logout */
        }
        #admin-sidebar nav ul li a i,
        #admin-sidebar #logout-btn i {
            margin-right: 12px;
            font-size: 1.1em;
        }
        #admin-sidebar nav ul li a:hover,
        #admin-sidebar #logout-btn:hover,
        #admin-sidebar nav ul li a.active {
            background-color: var(--color-primary);
            color: var(--color-surface);
        }

        #admin-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        #admin-header {
            background-color: var(--color-surface);
            padding: 20px 30px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }
        #admin-header h1 {
            margin: 0;
            font-family: var(--font-heading);
            color: var(--color-secondary);
            font-size: 2.2em;
        }
        #admin-header .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #admin-header .header-actions .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9em;
        }
        #admin-header .header-actions .btn .cart-badge {
            position: static;
            margin-left: 8px;
            padding: 2px 6px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 24px;
        }

        #admin-footer {
            text-align: center;
            padding: 25px;
            color: var(--color-text-light);
            font-size: 0.9em;
            border-top: 1px solid var(--color-border);
            margin-top: 40px;
        }

        /* --- Content Sections & General Elements --- */
        .content-section {
            background-color: var(--color-surface);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
        }
        .content-section h2 {
            font-family: var(--font-heading);
            color: var(--color-secondary);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2em;
            border-bottom: 1px dashed var(--color-border);
            padding-bottom: 15px;
        }

        /* Form Styling */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: .6rem;
            color: var(--color-secondary);
            font-size: 0.95em;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: .9rem 1.2rem;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--color-text);
            background-color: var(--color-background);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(216, 75, 66, 0.2);
            background-color: var(--color-surface);
        }
        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .75rem;
            font-family: var(--font-body);
            font-weight: 600;
            padding: .875rem 2rem;
            border-radius: 50px;
            border: 2px solid var(--color-primary);
            cursor: pointer;
            text-decoration: none;
            transition: all var(--transition-speed) ease;
            background-color: var(--color-primary);
            color: var(--color-surface);
            text-align: center;
            white-space: nowrap; /* Prevent text wrap on buttons */
        }
        .btn:hover {
            background-color: #b93e36;
            border-color: #b93e36;
            transform: translateY(-2px); /* Slightly less aggressive than public site */
            box-shadow: var(--shadow-sm);
        }
        .btn-secondary {
            background-color: var(--color-surface);
            color: var(--color-secondary);
            border-color: var(--color-secondary);
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary);
            color: var(--color-surface);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Table Styling */
        .table-responsive { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background-color: var(--color-surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        th {
            background-color: var(--color-secondary);
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:nth-child(even) { background-color: #FDFBFA; } /* Slight stripe effect */

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: .35em .8em;
            border-radius: 50px;
            font-size: 0.85em;
            font-weight: 600;
            color: #fff;
            text-transform: capitalize;
            min-width: 80px; /* Consistent width */
            text-align: center;
        }
        .status-badge.new { background-color: #007bff; }
        .status-badge.processing { background-color: #ffc107; color: #333; }
        .status-badge.completed { background-color: #28a745; }
        .status-badge.cancelled { background-color: #dc3545; }

        /* Action Buttons in Tables/Lists */
        .action-buttons button {
            background: none;
            border: none;
            font-size: 1.15em;
            cursor: pointer;
            margin-right: 12px;
            color: var(--color-secondary);
            transition: color 0.3s ease;
            padding: 5px; /* Increase click area */
        }
        .action-buttons button:last-child { margin-right: 0; }
        .action-buttons button:hover { color: var(--color-primary); }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .dashboard-stat-card {
            background-color: var(--color-surface);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }
        .dashboard-stat-card h3 {
            font-family: var(--font-heading);
            color: var(--color-secondary);
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .dashboard-stat-card p {
            font-size: 2.8em;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0;
            line-height: 1;
        }
        .dashboard-stat-card p.small {
            font-size: 1.2em;
            color: var(--color-text);
        }

        /* Image Previews */
        .image-preview {
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--color-border);
            display: none; /* Hidden by default */
        }
        .image-upload-group {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed);
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        .modal-content {
            background: var(--color-background);
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 600px; /* Lebar maksimum untuk modal */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(.9);
            transition: transform var(--transition-speed) ease;
            box-shadow: var(--shadow-lg);
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-surface);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        .modal-header h2 {
            font-family: var(--font-heading);
            color: var(--color-secondary);
            font-size: 1.75rem;
            margin: 0;
        }
        .modal-close-btn {
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s ease;
            padding: 0 5px;
            line-height: 1;
        }
        .modal-close-btn:hover { color: var(--color-primary); }
        .modal-body { padding: 2rem; }
        .modal-body .btn { width: 100%; margin-top: 1rem; }

        /* Toast Notification (reuse from public site) */
        .toast-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: var(--color-secondary);
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(calc(100% + 2rem));
            transition: transform .5s ease-in-out;
        }
        .toast-notification.show { transform: translateX(0); }
        .toast-notification.error { background-color: var(--color-primary); }
        .toast-notification.success { background-color: #28a745; }
        .toast-notification.info { background-color: var(--color-secondary); }
        .toast-notification i { font-size: 1.5rem; }
        .toast-notification p { margin: 0; }

        /* Media Queries for Responsiveness */
        @media (max-width: 992px) {
            body { flex-direction: column; }
            #admin-sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: var(--shadow-sm);
                padding: 15px 20px;
            }
            #admin-sidebar nav ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            #admin-sidebar nav ul li { margin-bottom: 0; }
            #admin-sidebar nav ul li a,
            #admin-sidebar #logout-btn {
                justify-content: center;
                text-align: center;
                font-size: 0.9em;
                padding: 10px 12px;
            }
            #admin-sidebar nav ul li a i,
            #admin-sidebar #logout-btn i { margin-right: 5px; }
            #admin-sidebar .logo { margin-bottom: 20px; }
            #admin-header { flex-direction: column; align-items: flex-start; gap: 15px; padding: 15px 20px; margin-bottom: 20px; }
            #admin-header h1 { font-size: 1.8em; }
            #admin-content { padding: 20px; }
            .content-section { padding: 20px; margin-bottom: 20px; }
            .content-section h2 { font-size: 1.8em; margin-bottom: 20px; }
            .dashboard-stats { grid-template-columns: 1fr; }
            th, td { padding: 10px 15px; }
        }

        @media (max-width: 576px) {
            #login-form-container { padding: 2rem; }
            #login-form-container h2 { font-size: 1.8rem; }
            #admin-sidebar nav ul li a,
            #admin-sidebar #logout-btn { padding: 8px 10px; font-size: 0.85em; }
            #admin-sidebar nav ul li a i,
            #admin-sidebar #logout-btn i { display: none; } /* Hide icons on very small screens if space is tight */
            .btn { padding: .75rem 1.5rem; font-size: 0.9em; }
            .modal-content { border-radius: 0; width: 100%; height: 100%; max-height: 100vh; }
            .modal-header, .modal-body { padding: 1.2rem; }
        }
    </style>
</head>
<body>

    <div id="login-page">
        <div id="login-form-container">
            <img src="https://i.ibb.co/L8yN5s2/Logo-Lobster-Shack.png" alt="Logo Lobster Shack" class="logo">
            <h2>Admin Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required placeholder="Password">
                </div>
                <button type="submit" class="btn" id="login-btn">Login</button>
                <p id="login-error-message" style="color: var(--color-primary); margin-top: 10px;"></p>
            </form>
        </div>
    </div>

    <div id="admin-panel-container">
        <div id="admin-sidebar">
            <img src="https://i.ibb.co/L8yN5s2/Logo-Lobster-Shack.png" alt="Lobster Shack Admin" class="logo">
            <nav>
                <ul>
                    <li><a href="#dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="#orders"><i class="fas fa-clipboard-list"></i> Pesanan</a></li>
                    <li><a href="#products"><i class="fas fa-fish"></i> Produk</a></li>
                    <li><a href="#categories"><i class="fas fa-tags"></i> Kategori</a></li>
                    <li><a href="#content"><i class="fas fa-pencil-ruler"></i> Konten Website</a></li>
                    <li><a href="#banners"><i class="fas fa-image"></i> Banner Slider</a></li>
                    <li><a href="#gallery-images"><i class="fas fa-camera"></i> Galeri</a></li>
                    <li><a href="#history"><i class="fas fa-history"></i> Riwayat Kami</a></li>
                    <li><a href="#profile"><i class="fas fa-user-circle"></i> Profil Admin</a></li>
                    <li><button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
                </ul>
            </nav>
        </div>

        <div id="admin-content">
            <header id="admin-header">
                <h1 id="current-page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary"><i class="fas fa-bell"></i> Notifikasi <span class="cart-badge" id="admin-notification-badge" style="display:none;">0</span></button>
                </div>
            </header>

            <main>
                <section id="dashboard" class="content-section">
                    <h2>Ringkasan Dashboard</h2>
                    <div class="dashboard-stats">
                        <div class="dashboard-stat-card">
                            <h3>Total Pesanan Hari Ini</h3>
                            <p id="total-orders-today">0</p>
                        </div>
                        <div class="dashboard-stat-card">
                            <h3>Pendapatan Hari Ini</h3>
                            <p id="revenue-today">Rp 0</p>
                        </div>
                        <div class="dashboard-stat-card">
                            <h3>Produk Paling Populer</h3>
                            <p class="small" id="top-product-today">-</p>
                        </div>
                    </div>
                </section>

                <section id="orders" class="content-section" style="display:none;">
                    <h2>Manajemen Pesanan</h2>
                    <div class="table-responsive">
                        <table id="orders-table">
                            <thead>
                                <tr>
                                    <th>ID Pesanan</th>
                                    <th>Nama</th>
                                    <th>Telepon</th>
                                    <th>Alamat</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Waktu Pesan</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </section>

                <section id="products" class="content-section" style="display:none;">
                    <h2>Manajemen Produk</h2>
                    <button class="btn" id="add-product-btn" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Tambah Produk Baru</button>
                    <div class="table-responsive">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>Gambar</th>
                                    <th>Nama (ID)</th>
                                    <th>Nama (EN)</th>
                                    <th>Harga</th>
                                    <th>Kategori</th>
                                    <th>Unggulan</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </section>

                <section id="categories" class="content-section" style="display:none;">
                    <h2>Manajemen Kategori</h2>
                    <button class="btn" id="add-category-btn" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Tambah Kategori Baru</button>
                    <div class="table-responsive">
                        <table id="categories-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nama Kategori</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </section>

                <section id="content" class="content-section" style="display:none;">
                    <h2>Manajemen Konten Website</h2>
                    <form id="content-form">
                        <p style="margin-bottom: 20px; color: var(--color-text-light);">Ubah teks statis di situs utama Anda. Perhatikan bahwa Anda perlu mengklik tombol "Simpan Konten" setelah semua perubahan dilakukan.</p>

                        <div class="form-group">
                            <label for="content_page_title_id">Judul Halaman (ID)</label>
                            <input type="text" id="content_page_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_page_title_en">Judul Halaman (EN)</label>
                            <input type="text" id="content_page_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_hero_title_id">Judul Hero (ID)</label>
                            <input type="text" id="content_hero_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_hero_title_en">Judul Hero (EN)</label>
                            <input type="text" id="content_hero_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_hero_subtitle_id">Sub Judul Hero (ID)</label>
                            <textarea id="content_hero_subtitle_id" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="content_hero_subtitle_en">Sub Judul Hero (EN)</label>
                            <textarea id="content_hero_subtitle_en" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="content_footer_description_id">Deskripsi Footer (ID)</label>
                            <textarea id="content_footer_description_id" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="content_footer_description_en">Deskripsi Footer (EN)</label>
                            <textarea id="content_footer_description_en" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="content_history_title_id">Judul Riwayat (ID)</label>
                            <input type="text" id="content_history_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_history_title_en">Judul Riwayat (EN)</label>
                            <input type="text" id="content_history_title_en">
                        </div>
                         <div class="form-group">
                            <label for="content_menu_section_subtitle_id">Subtitle Bagian Menu (ID)</label>
                            <input type="text" id="content_menu_section_subtitle_id">
                        </div>
                        <div class="form-group">
                            <label for="content_menu_section_subtitle_en">Subtitle Bagian Menu (EN)</label>
                            <input type="text" id="content_menu_section_subtitle_en">
                        </div>
                        <div class="form-group">
                            <label for="content_menu_title_id">Judul Menu Rekomendasi (ID)</label>
                            <input type="text" id="content_menu_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_menu_title_en">Judul Menu Rekomendasi (EN)</label>
                            <input type="text" id="content_menu_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_full_menu_title_id">Judul Menu Lengkap (ID)</label>
                            <input type="text" id="content_full_menu_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_full_menu_title_en">Judul Menu Lengkap (EN)</label>
                            <input type="text" id="content_full_menu_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_gallery_section_subtitle_id">Subtitle Bagian Galeri (ID)</label>
                            <input type="text" id="content_gallery_section_subtitle_id">
                        </div>
                        <div class="form-group">
                            <label for="content_gallery_section_subtitle_en">Subtitle Bagian Galeri (EN)</label>
                            <input type="text" id="content_gallery_section_subtitle_en">
                        </div>
                        <div class="form-group">
                            <label for="content_gallery_title_id">Judul Galeri (ID)</label>
                            <input type="text" id="content_gallery_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_gallery_title_en">Judul Galeri (EN)</label>
                            <input type="text" id="content_gallery_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_contact_title_id">Judul Kontak Footer (ID)</label>
                            <input type="text" id="content_footer_contact_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_contact_title_en">Judul Kontak Footer (EN)</label>
                            <input type="text" id="content_footer_contact_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_address_label_id">Label Alamat Footer (ID)</label>
                            <input type="text" id="content_footer_address_label_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_address_label_en">Label Alamat Footer (EN)</label>
                            <input type="text" id="content_footer_address_label_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_address_value_id">Nilai Alamat Footer (ID)</label>
                            <textarea id="content_footer_address_value_id" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="content_footer_address_value_en">Nilai Alamat Footer (EN)</label>
                            <textarea id="content_footer_address_value_en" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="content_footer_phone_label_id">Label Telepon Footer (ID)</label>
                            <input type="text" id="content_footer_phone_label_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_phone_label_en">Label Telepon Footer (EN)</label>
                            <input type="text" id="content_footer_phone_label_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_phone_value_id">Nilai Telepon Footer (ID)</label>
                            <input type="text" id="content_footer_phone_value_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_phone_value_en">Nilai Telepon Footer (EN)</label>
                            <input type="text" id="content_footer_phone_value_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_email_label_id">Label Email Footer (ID)</label>
                            <input type="text" id="content_footer_email_label_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_email_label_en">Label Email Footer (EN)</label>
                            <input type="text" id="content_footer_email_label_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_email_value_id">Nilai Email Footer (ID)</label>
                            <input type="text" id="content_footer_email_value_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_email_value_en">Nilai Email Footer (EN)</label>
                            <input type="text" id="content_footer_email_value_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_hours_label_id">Label Jam Buka Footer (ID)</label>
                            <input type="text" id="content_footer_hours_label_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_hours_label_en">Label Jam Buka Footer (EN)</label>
                            <input type="text" id="content_footer_hours_label_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_hours_value_id">Nilai Jam Buka Footer (ID)</label>
                            <input type="text" id="content_footer_hours_value_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_hours_value_en">Nilai Jam Buka Footer (EN)</label>
                            <input type="text" id="content_footer_hours_value_en">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_copyright_id">Hak Cipta Footer (ID)</label>
                            <input type="text" id="content_footer_copyright_id">
                        </div>
                        <div class="form-group">
                            <label for="content_footer_copyright_en">Hak Cipta Footer (EN)</label>
                            <input type="text" id="content_footer_copyright_en">
                        </div>
                         <div class="form-group">
                            <label for="content_add_to_cart_btn_id">Teks Tombol 'Add to Cart' (ID)</label>
                            <input type="text" id="content_add_to_cart_btn_id">
                        </div>
                        <div class="form-group">
                            <label for="content_add_to_cart_btn_en">Teks Tombol 'Add to Cart' (EN)</label>
                            <input type="text" id="content_add_to_cart_btn_en">
                        </div>
                        <div class="form-group">
                            <label for="content_order_now_btn_id">Teks Tombol 'Order Now' (ID)</label>
                            <input type="text" id="content_order_now_btn_id">
                        </div>
                        <div class="form-group">
                            <label for="content_order_now_btn_en">Teks Tombol 'Order Now' (EN)</label>
                            <input type="text" id="content_order_now_btn_en">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_title_id">Judul Modal Pesanan (ID)</label>
                            <input type="text" id="content_modal_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_title_en">Judul Modal Pesanan (EN)</label>
                            <input type="text" id="content_modal_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_name_label_id">Label Nama Modal (ID)</label>
                            <input type="text" id="content_modal_name_label_id">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_name_label_en">Label Nama Modal (EN)</label>
                            <input type="text" id="content_modal_name_label_en">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_phone_label_id">Label Telepon Modal (ID)</label>
                            <input type="text" id="content_modal_phone_label_id">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_phone_label_en">Label Telepon Modal (EN)</label>
                            <input type="text" id="content_modal_phone_label_en">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_detect_location_id">Teks Deteksi Lokasi Modal (ID)</label>
                            <input type="text" id="content_modal_detect_location_id">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_detect_location_en">Teks Deteksi Lokasi Modal (EN)</label>
                            <input type="text" id="content_modal_detect_location_en">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_submit_button_id">Teks Tombol Submit Modal (ID)</label>
                            <input type="text" id="content_modal_submit_button_id">
                        </div>
                        <div class="form-group">
                            <label for="content_modal_submit_button_en">Teks Tombol Submit Modal (EN)</label>
                            <input type="text" id="content_modal_submit_button_en">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_title_id">Judul Keranjang (ID)</label>
                            <input type="text" id="content_cart_title_id">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_title_en">Judul Keranjang (EN)</label>
                            <input type="text" id="content_cart_title_en">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_subtotal_id">Label Subtotal Keranjang (ID)</label>
                            <input type="text" id="content_cart_subtotal_id">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_subtotal_en">Label Subtotal Keranjang (EN)</label>
                            <input type="text" id="content_cart_subtotal_en">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_delivery_fee_id">Label Ongkir Keranjang (ID)</label>
                            <input type="text" id="content_cart_delivery_fee_id">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_delivery_fee_en">Label Ongkir Keranjang (EN)</label>
                            <input type="text" id="content_cart_delivery_fee_en">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_total_id">Label Total Keranjang (ID)</label>
                            <input type="text" id="content_cart_total_id">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_total_en">Label Total Keranjang (EN)</label>
                            <input type="text" id="content_cart_total_en">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_checkout_button_id">Teks Tombol Checkout Keranjang (ID)</label>
                            <input type="text" id="content_cart_checkout_button_id">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_checkout_button_en">Teks Tombol Checkout Keranjang (EN)</label>
                            <input type="text" id="content_cart_checkout_button_en">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_continue_shopping_id">Teks Tombol Lanjut Belanja (ID)</label>
                            <input type="text" id="content_cart_continue_shopping_id">
                        </div>
                        <div class="form-group">
                            <label for="content_cart_continue_shopping_en">Teks Tombol Lanjut Belanja (EN)</label>
                            <input type="text" id="content_cart_continue_shopping_en">
                        </div>


                        <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan Konten</button>
                    </form>
                </section>

                <section id="banners" class="content-section" style="display:none;">
                    <h2>Manajemen Banner Slider</h2>
                    <button class="btn" id="add-banner-btn" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Tambah Banner Baru</button>
                    <div id="banner-list" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                        </div>
                </section>

                <section id="gallery-images" class="content-section" style="display:none;">
                    <h2>Manajemen Gambar Galeri</h2>
                    <button class="btn" id="add-gallery-image-btn" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Tambah Gambar Galeri</button>
                    <div id="gallery-image-list" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:20px;">
                        </div>
                </section>

                <section id="history" class="content-section" style="display:none;">
                    <h2>Manajemen Riwayat Kami</h2>
                    <button class="btn" id="add-history-btn" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Tambah Item Riwayat</button>
                    <div id="history-list">
                        </div>
                </section>

                <section id="profile" class="content-section" style="display:none;">
                    <h2>Profil Admin</h2>
                    <form id="admin-profile-form">
                        <div class="form-group">
                            <label for="admin-name">Nama Admin</label>
                            <input type="text" id="admin-name" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-email">Email</label>
                            <input type="email" id="admin-email" disabled> </div>
                        <div class="form-group">
                            <label for="admin-phone">Telepon</label>
                            <input type="tel" id="admin-phone">
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-save"></i> Perbarui Profil</button>
                    </form>
                </section>
            </main>

            <footer id="admin-footer">
                <p>&copy; 2025 Lobster Shack Bali Admin Panel. All Rights Reserved.</p>
            </footer>
        </div>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="product-modal-title">Tambah Produk</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-group">
                        <label for="product-name-id">Nama Produk (ID)</label>
                        <input type="text" id="product-name-id" required>
                    </div>
                    <div class="form-group">
                        <label for="product-name-en">Nama Produk (EN)</label>
                        <input type="text" id="product-name-en" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Harga</label>
                        <input type="number" id="product-price" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">Kategori</label>
                        <select id="product-category" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="product-description-id">Deskripsi (ID)</label>
                        <textarea id="product-description-id" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="product-description-en">Deskripsi (EN)</label>
                        <textarea id="product-description-en" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Gambar Produk</label>
                        <input type="url" id="product-image-url" placeholder="Paste URL gambar (opsional)">
                        <div class="image-upload-group">
                            <label for="product-image-upload" style="font-weight:normal;">Atau Unggah File:</label>
                            <input type="file" id="product-image-upload" accept="image/*">
                        </div>
                        <img id="product-image-preview" src="" alt="Preview Gambar Produk" class="image-preview">
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="product-is-featured">
                        <label for="product-is-featured" style="display:inline; margin-left:5px;">Produk Unggulan</label>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan Produk</button>
                </form>
            </div>
        </div>
    </div>

    <div id="category-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="category-modal-title">Tambah Kategori</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id-field">
                    <div class="form-group">
                        <label for="category-name-field">Nama Kategori</label>
                        <input type="text" id="category-name-field" required>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan Kategori</button>
                </form>
            </div>
        </div>
    </div>

    <div id="banner-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="banner-modal-title">Tambah Banner</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="banner-form">
                    <input type="hidden" id="banner-id">
                    <div class="form-group">
                        <label>Gambar Banner</label>
                        <input type="url" id="banner-image-url-field" placeholder="Paste URL gambar (opsional)">
                        <div class="image-upload-group">
                            <label for="banner-image-upload-field" style="font-weight:normal;">Atau Unggah File:</label>
                            <input type="file" id="banner-image-upload-field" accept="image/*">
                        </div>
                        <img id="banner-image-preview" src="" alt="Preview Gambar Banner" class="image-preview">
                    </div>
                    <div class="form-group">
                        <label for="banner-sort-order">Urutan Tampilan</label>
                        <input type="number" id="banner-sort-order" min="0" value="0">
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan Banner</button>
                </form>
            </div>
        </div>
    </div>

    <div id="gallery-image-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="gallery-image-modal-title">Tambah Gambar Galeri</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="gallery-image-form">
                    <input type="hidden" id="gallery-image-id">
                    <div class="form-group">
                        <label>Gambar Galeri</label>
                        <input type="url" id="gallery-image-url-field" placeholder="Paste URL gambar (opsional)">
                        <div class="image-upload-group">
                            <label for="gallery-image-upload-field" style="font-weight:normal;">Atau Unggah File:</label>
                            <input type="file" id="gallery-image-upload-field" accept="image/*">
                        </div>
                        <img id="gallery-image-preview" src="" alt="Preview Gambar Galeri" class="image-preview">
                    </div>
                    <div class="form-group">
                        <label for="gallery-image-caption-id">Keterangan (ID)</label>
                        <textarea id="gallery-image-caption-id" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="gallery-image-caption-en">Keterangan (EN)</label>
                        <textarea id="gallery-image-caption-en" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="gallery-image-sort-order">Urutan Tampilan</label>
                        <input type="number" id="gallery-image-sort-order" min="0" value="0">
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan Gambar</button>
                </form>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="history-modal-title">Tambah Item Riwayat</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="history-form">
                    <input type="hidden" id="history-id">
                    <div class="form-group">
                        <label for="history-year">Tahun</label>
                        <input type="number" id="history-year" min="1900" max="2100" required>
                    </div>
                    <div class="form-group">
                        <label for="history-title-id">Judul (ID)</label>
                        <input type="text" id="history-title-id" required>
                    </div>
                    <div class="form-group">
                        <label for="history-title-en">Judul (EN)</label>
                        <input type="text" id="history-title-en" required>
                    </div>
                    <div class="form-group">
                        <label for="history-text-id">Deskripsi (ID)</label>
                        <textarea id="history-text-id" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="history-text-en">Deskripsi (EN)</label>
                        <textarea id="history-text-en" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="history-sort-order">Urutan Tampilan</label>
                        <input type="number" id="history-sort-order" min="0" value="0">
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Simpan Riwayat</button>
                </form>
            </div>
        </div>
    </div>


    <div id="toast" class="toast-notification">
        <i id="toast-icon" class="fas fa-check-circle"></i>
        <p id="toast-message">Notification</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        'use strict';

        // =================================================================================
        // KONFIGURASI PROYEK FIREBASE (WAJIB DIISI)
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCIC1WLirQbsY8XDsVhMWHVv8GO2nwcyjk", // Ganti dengan API Key Anda
            authDomain: "lobster-shack-bali.firebaseapp.com",
            databaseURL: "https://lobster-shack-bali-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lobster-shack-bali",
            storageBucket: "lobster-shack-bali.firebasestorage.app",
            messagingSenderId: "42452974733",
            appId: "1:42452974733:web:5cad780f8295edd2b5f6c4"
        };
        // =================================================================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- Variabel DOM Admin Panel ---
        const adminDom = {
            loginPage: document.getElementById('login-page'),
            loginForm: document.getElementById('login-form'),
            loginEmail: document.getElementById('login-email'),
            loginPassword: document.getElementById('login-password'),
            loginError: document.getElementById('login-error-message'),
            loginBtn: document.getElementById('login-btn'),

            adminPanelContainer: document.getElementById('admin-panel-container'),
            sidebar: document.getElementById('admin-sidebar'),
            contentArea: document.getElementById('admin-content'),
            currentPageTitle: document.getElementById('current-page-title'),
            notificationBadge: document.getElementById('admin-notification-badge'),
            logoutBtn: document.getElementById('logout-btn'),

            // Sections
            dashboardSection: document.getElementById('dashboard'),
            ordersSection: document.getElementById('orders'),
            productsSection: document.getElementById('products'),
            categoriesSection: document.getElementById('categories'),
            contentSection: document.getElementById('content'),
            bannersSection: document.getElementById('banners'),
            galleryImagesSection: document.getElementById('gallery-images'),
            historySection: document.getElementById('history'),
            profileSection: document.getElementById('profile'),

            // Tables
            ordersTableBody: document.querySelector('#orders-table tbody'),
            productsTableBody: document.querySelector('#products-table tbody'),
            categoriesTableBody: document.querySelector('#categories-table tbody'),

            // Buttons
            addProductBtn: document.getElementById('add-product-btn'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            addBannerBtn: document.getElementById('add-banner-btn'),
            addGalleryImageBtn: document.getElementById('add-gallery-image-btn'),
            addHistoryBtn: document.getElementById('add-history-btn'),

            // Forms & Modals
            productModal: document.getElementById('product-modal'),
            productModalTitle: document.getElementById('product-modal-title'),
            productForm: document.getElementById('product-form'),
            productIdField: document.getElementById('product-id'),
            productNameIdField: document.getElementById('product-name-id'),
            productNameEnField: document.getElementById('product-name-en'),
            productPriceField: document.getElementById('product-price'),
            productCategoryField: document.getElementById('product-category'),
            productDescriptionIdField: document.getElementById('product-description-id'),
            productDescriptionEnField: document.getElementById('product-description-en'),
            productImageUrlField: document.getElementById('product-image-url'),
            productImageUploadField: document.getElementById('product-image-upload'),
            productImagePreview: document.getElementById('product-image-preview'),
            productIsFeaturedField: document.getElementById('product-is-featured'),

            categoryModal: document.getElementById('category-modal'),
            categoryModalTitle: document.getElementById('category-modal-title'),
            categoryForm: document.getElementById('category-form'),
            categoryIdField: document.getElementById('category-id-field'),
            categoryNameField: document.getElementById('category-name-field'),

            bannerModal: document.getElementById('banner-modal'),
            bannerModalTitle: document.getElementById('banner-modal-title'),
            bannerForm: document.getElementById('banner-form'),
            bannerIdField: document.getElementById('banner-id'),
            bannerImageUrlField: document.getElementById('banner-image-url-field'),
            bannerImageUploadField: document.getElementById('banner-image-upload-field'),
            bannerImagePreview: document.getElementById('banner-image-preview'),
            bannerSortOrderField: document.getElementById('banner-sort-order'),
            bannerList: document.getElementById('banner-list'),

            galleryImageModal: document.getElementById('gallery-image-modal'),
            galleryImageModalTitle: document.getElementById('gallery-image-modal-title'),
            galleryImageForm: document.getElementById('gallery-image-form'),
            galleryImageIdField: document.getElementById('gallery-image-id'),
            galleryImageUrlField: document.getElementById('gallery-image-url-field'),
            galleryImageUploadField: document.getElementById('gallery-image-upload-field'),
            galleryImagePreview: document.getElementById('gallery-image-preview'),
            galleryImageCaptionIdField: document.getElementById('gallery-image-caption-id'),
            galleryImageCaptionEnField: document.getElementById('gallery-image-caption-en'),
            galleryImageSortOrderField: document.getElementById('gallery-image-sort-order'),
            galleryImageList: document.getElementById('gallery-image-list'),

            historyModal: document.getElementById('history-modal'),
            historyModalTitle: document.getElementById('history-modal-title'),
            historyForm: document.getElementById('history-form'),
            historyIdField: document.getElementById('history-id'),
            historyYearField: document.getElementById('history-year'),
            historyTitleIdField: document.getElementById('history-title-id'),
            historyTitleEnField: document.getElementById('history-title-en'),
            historyTextIdField: document.getElementById('history-text-id'),
            historyTextEnField: document.getElementById('history-text-en'),
            historySortOrderField: document.getElementById('history-sort-order'),
            historyList: document.getElementById('history-list'),

            contentForm: document.getElementById('content-form'),
            // Referensi ke semua input konten akan diambil saat renderContent

            adminProfileForm: document.getElementById('admin-profile-form'),
            adminNameField: document.getElementById('admin-name'),
            adminEmailField: document.getElementById('admin-email'),
            adminPhoneField: document.getElementById('admin-phone'),

            // Dashboard Stats
            totalOrdersToday: document.getElementById('total-orders-today'),
            revenueToday: document.getElementById('revenue-today'),
            topProductToday: document.getElementById('top-product-today'),

            // Toast (re-use from public site concept)
            toast: document.getElementById('toast'),
            toastIcon: document.getElementById('toast-icon'),
            toastMessage: document.getElementById('toast-message'),
        };

        // --- Variabel Global Admin ---
        let adminData = {}; // Menyimpan data profil admin yang login
        let currentActiveSection = 'dashboard';
        let categoriesData = []; // Cache kategori untuk dropdown produk

        // --- Fungsi Helper Umum ---
        const showToast = (message, type = 'info') => {
            adminDom.toastMessage.textContent = message;
            adminDom.toast.className = 'toast-notification'; // Reset classes
            adminDom.toast.classList.add(type, 'show');
            const iconMap = { 'success': 'fa-check-circle', 'error': 'fa-times-circle', 'info': 'fa-info-circle' };
            adminDom.toastIcon.className = `fas ${iconMap[type] || 'fa-info-circle'}`;
            setTimeout(() => {
                adminDom.toast.classList.remove('show');
            }, 4000);
        };

        const openModal = (modalElement) => {
            modalElement.classList.add('visible');
            document.body.style.overflow = 'hidden';
        };

        const closeModal = (modalElement) => {
            modalElement.classList.remove('visible');
            document.body.style.overflow = '';
        };

        // --- Autentikasi Admin ---
        // Fungsi untuk menampilkan halaman login
        const showLoginPage = () => {
            adminDom.loginPage.style.display = 'flex';
            adminDom.adminPanelContainer.style.visibility = 'hidden';
            adminDom.adminPanelContainer.style.opacity = '0';
        };

        // Fungsi untuk menampilkan panel admin
        const showAdminPanel = () => {
            adminDom.loginPage.style.display = 'none';
            adminDom.adminPanelContainer.style.visibility = 'visible';
            adminDom.adminPanelContainer.style.opacity = '1';
        };

        // Listener status autentikasi Firebase
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Pengguna login, cek klaim kustom 'admin'
                const idTokenResult = await user.getIdTokenResult();
                if (idTokenResult.claims.admin) {
                    console.log("Admin logged in!");
                    showAdminPanel();
                    // Fetch atau buat profil admin
                    const adminDoc = await db.collection('admins').doc(user.uid).get();
                    if (adminDoc.exists) {
                        adminData = { id: adminDoc.id, ...adminDoc.data() };
                    } else {
                        await db.collection('admins').doc(user.uid).set({
                            name: user.displayName || 'Admin Default',
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        const newAdminDoc = await db.collection('admins').doc(user.uid).get();
                        adminData = { id: newAdminDoc.id, ...newAdminDoc.data() };
                    }
                    initializeAdminPanel();
                } else {
                    // Pengguna bukan admin, paksa logout
                    console.warn("User is not an admin. Logging out.");
                    showToast("Akses Ditolak: Anda bukan admin.", 'error');
                    await auth.signOut();
                    showLoginPage();
                }
            } else {
                // Tidak ada pengguna login, tampilkan halaman login
                console.log("No user logged in. Showing login page.");
                showLoginPage();
            }
        });

        // Event listener untuk form login
        adminDom.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = adminDom.loginEmail.value;
            const password = adminDom.loginPassword.value;
            adminDom.loginBtn.disabled = true;
            adminDom.loginError.textContent = ''; // Clear previous errors

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // AuthStateChanged listener akan menangani redirect setelah login berhasil
            } catch (error) {
                console.error("Login error:", error);
                adminDom.loginError.textContent = 'Login gagal: ' + error.message;
            } finally {
                adminDom.loginBtn.disabled = false;
            }
        });

        // Event listener untuk logout
        adminDom.logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showToast("Berhasil logout.", 'success');
            } catch (error) {
                console.error("Logout error:", error);
                showToast("Gagal logout: " + error.message, 'error');
            }
        });

        // --- Inisialisasi Panel Admin Setelah Login ---
        const initializeAdminPanel = () => {
            // Setup navigasi sidebar
            adminDom.sidebar.querySelectorAll('nav ul li a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    adminDom.sidebar.querySelectorAll('nav ul li a').forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const targetSectionId = e.currentTarget.getAttribute('href').substring(1);
                    showSection(targetSectionId);
                });
            });

            // Set up event listeners for all modals, forms, and buttons
            setupEventListeners();
            
            // Load initial data and set up real-time listeners
            loadDashboardStats();
            setupRealtimeListeners(); // Ini akan memanggil renderOrders, dll.
            showSection(currentActiveSection); // Tampilkan bagian dashboard secara default
        };

        const showSection = (sectionId) => {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active-section');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active-section');
                adminDom.currentPageTitle.textContent = targetSection.querySelector('h2').textContent;
                currentActiveSection = sectionId;

                // Memastikan data dimuat/dirender saat section ditampilkan
                switch (sectionId) {
                    case 'orders': renderOrders(); break;
                    case 'products': renderProducts(); break;
                    case 'categories': renderCategories(); break;
                    case 'content': renderContent(); break;
                    case 'banners': renderBannersAdmin(); break;
                    case 'gallery-images': renderGalleryImagesAdmin(); break;
                    case 'history': renderHistoryAdmin(); break;
                    case 'profile':
                        adminDom.adminNameField.value = adminData.name || '';
                        adminDom.adminEmailField.value = auth.currentUser.email || '';
                        adminDom.adminPhoneField.value = adminData.phone || '';
                        break;
                }
            }
        };

        // --- Dashboard Stats (Realtime) ---
        const loadDashboardStats = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            db.collection('orders')
                .where('timestamp', '>=', today)
                .where('timestamp', '<', tomorrow)
                .onSnapshot(snapshot => {
                    let totalOrders = 0;
                    let totalRevenue = 0;
                    const productSales = {};

                    snapshot.forEach(doc => {
                        const order = doc.data();
                        totalOrders++;
                        totalRevenue += order.totalAmount || 0;

                        if (order.orderDetails) {
                            order.orderDetails.forEach(item => {
                                const productName = item.name;
                                productSales[productName] = (productSales[productName] || 0) + item.quantity;
                            });
                        }
                    });

                    adminDom.totalOrdersToday.textContent = totalOrders;
                    adminDom.revenueToday.textContent = `Rp ${new Intl.NumberFormat('id-ID').format(totalRevenue)}`;

                    let topProduct = 'N/A';
                    let maxSales = 0;
                    for (const product in productSales) {
                        if (productSales[product] > maxSales) {
                            maxSales = productSales[product];
                            topProduct = product;
                        }
                    }
                    adminDom.topProductToday.textContent = topProduct;

                    const newOrdersCount = snapshot.docs.filter(doc => doc.data().status === 'new').length;
                    adminDom.notificationBadge.textContent = newOrdersCount;
                    adminDom.notificationBadge.style.display = newOrdersCount > 0 ? 'inline-block' : 'none';
                }, error => {
                    console.error("Error loading dashboard stats:", error);
                    showToast("Gagal memuat statistik dashboard.", 'error');
                });
        };

        // --- Realtime Listeners for Orders and Categories ---
        const setupRealtimeListeners = () => {
            // Realtime listener for Orders
            db.collection('orders').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Hanya render jika section orders aktif atau di dashboard untuk update badge
                if (currentActiveSection === 'orders' || currentActiveSection === 'dashboard') {
                    renderOrders(orders);
                }
            }, error => {
                console.error("Error fetching real-time orders:", error);
                showToast("Gagal memuat pesanan real-time.", 'error');
            });

            // Realtime listener for Categories to keep product dropdown updated
            db.collection('categories').orderBy('id').onSnapshot(snapshot => {
                categoriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCategoryDropdown();
                // Re-render categories table if section is active
                if (currentActiveSection === 'categories') {
                    renderCategories();
                }
            }, error => {
                console.error("Error fetching categories for dropdown:", error);
                showToast("Gagal memuat kategori.", 'error');
            });

            // Realtime listener for Products
            db.collection('products').onSnapshot(snapshot => {
                if (currentActiveSection === 'products') {
                    renderProducts(); // Will re-fetch and render
                }
            }, error => {
                console.error("Error fetching real-time products:", error);
            });
             // Realtime listener for Banners
            db.collection('banners').onSnapshot(snapshot => {
                if (currentActiveSection === 'banners') {
                    renderBannersAdmin();
                }
            });
            // Realtime listener for Gallery Images
            db.collection('gallery_images').onSnapshot(snapshot => {
                if (currentActiveSection === 'gallery-images') {
                    renderGalleryImagesAdmin();
                }
            });
            // Realtime listener for History
            db.collection('history').onSnapshot(snapshot => {
                if (currentActiveSection === 'history') {
                    renderHistoryAdmin();
                }
            });
        };

        // --- Rendering Functions ---

        const renderOrders = (orders) => {
            adminDom.ordersTableBody.innerHTML = '';
            if (orders.length === 0) {
                adminDom.ordersTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Tidak ada pesanan.</td></tr>`;
                return;
            }

            orders.forEach(order => {
                const row = adminDom.ordersTableBody.insertRow();
                row.insertCell().textContent = order.id.substring(0, 6); // Short ID
                row.insertCell().textContent = order.customerName || 'N/A';
                row.insertCell().textContent = order.customerPhone || 'N/A';
                row.insertCell().textContent = order.customerAddress || 'N/A';
                row.insertCell().textContent = `Rp ${new Intl.NumberFormat('id-ID').format(order.totalAmount || 0)}`;
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<span class="status-badge ${order.status}">${order.status ? (order.status.charAt(0).toUpperCase() + order.status.slice(1)) : 'N/A'}</span>`;
                row.insertCell().textContent = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                actionsCell.innerHTML = `
                    <button title="Lihat Detail" data-id="${order.id}" data-action="view"><i class="fas fa-eye"></i></button>
                    <button title="Ubah Status" data-id="${order.id}" data-action="status"><i class="fas fa-edit"></i></button>
                    <button title="Hapus Pesanan" data-id="${order.id}" data-action="delete"><i class="fas fa-trash-alt"></i></button>
                    <button title="Follow Up Customer (WhatsApp)" data-id="${order.id}" data-action="whatsapp"><i class="fab fa-whatsapp"></i></button>
                `;
            });
        };

        const renderProducts = async () => {
            adminDom.productsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Memuat produk...</td></tr>';
            try {
                const snapshot = await db.collection('products').get();
                const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                adminDom.productsTableBody.innerHTML = '';
                if (products.length === 0) {
                    adminDom.productsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Tidak ada produk.</td></tr>`;
                    return;
                }

                products.forEach(p => {
                    const row = adminDom.productsTableBody.insertRow();
                    row.insertCell().innerHTML = `<img src="${p.imageUrl}" alt="${p.name_en}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">`;
                    row.insertCell().textContent = p.name_id;
                    row.insertCell().textContent = p.name_en;
                    row.insertCell().textContent = `Rp ${new Intl.NumberFormat('id-ID').format(p.price)}`;
                    row.insertCell().textContent = p.category_name || 'Uncategorized';
                    row.insertCell().textContent = p.is_featured ? 'Ya' : 'Tidak';
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-buttons';
                    actionsCell.innerHTML = `
                        <button title="Edit Produk" data-id="${p.id}" data-action="edit-product"><i class="fas fa-edit"></i></button>
                        <button title="Hapus Produk" data-id="${p.id}" data-action="delete-product"><i class="fas fa-trash-alt"></i></button>
                    `;
                });
            } catch (error) {
                console.error("Error rendering products:", error);
                showToast("Gagal memuat produk.", 'error');
                adminDom.productsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Gagal memuat produk.</td></tr>`;
            }
        };

        const renderCategories = async () => {
             adminDom.categoriesTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Memuat kategori...</td></tr>';
            try {
                // categoriesData already updated by realtime listener
                adminDom.categoriesTableBody.innerHTML = '';
                if (categoriesData.length === 0) {
                    adminDom.categoriesTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Tidak ada kategori.</td></tr>`;
                    return;
                }

                categoriesData.forEach(c => {
                    const row = adminDom.categoriesTableBody.insertRow();
                    row.insertCell().textContent = c.id.substring(0, 6);
                    row.insertCell().textContent = c.name;
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-buttons';
                    actionsCell.innerHTML = `
                        <button title="Edit Kategori" data-id="${c.id}" data-action="edit-category"><i class="fas fa-edit"></i></button>
                        <button title="Hapus Kategori" data-id="${c.id}" data-action="delete-category"><i class="fas fa-trash-alt"></i></button>
                    `;
                });
            } catch (error) {
                console.error("Error rendering categories:", error);
                showToast("Gagal memuat kategori.", 'error');
                adminDom.categoriesTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Gagal memuat kategori.</td></tr>`;
            }
        };

        const renderContent = async () => {
            try {
                const snapshot = await db.collection('content').get();
                const contentMap = {}; // Map doc.id to doc.data()
                snapshot.docs.forEach(doc => {
                    contentMap[doc.id] = doc.data();
                });

                // Populate content form fields dynamically based on their IDs
                const contentFieldIds = [
                    'page_title', 'hero_title', 'hero_subtitle', 'footer_description', 'history_title',
                    'menu_section_subtitle', 'menu_title', 'full_menu_title', 'gallery_section_subtitle', 'gallery_title',
                    'footer_contact_title', 'footer_address_label', 'footer_address_value', 'footer_phone_label',
                    'footer_phone_value', 'footer_email_label', 'footer_email_value', 'footer_hours_label',
                    'footer_hours_value', 'footer_copyright', 'add_to_cart_btn', 'order_now_btn', 'modal_title',
                    'modal_name_label', 'modal_phone_label', 'modal_detect_location', 'modal_submit_button',
                    'cart_title', 'cart_subtotal', 'cart_delivery_fee', 'cart_total', 'cart_checkout_button', 'cart_continue_shopping'
                ];

                for (const fieldId of contentFieldIds) {
                    const idInput = document.getElementById(`content_${fieldId}_id`);
                    const enInput = document.getElementById(`content_${fieldId}_en`);

                    if (idInput && contentMap[fieldId]) {
                        idInput.value = contentMap[fieldId].text_id || '';
                    }
                    if (enInput && contentMap[fieldId]) {
                        enInput.value = contentMap[fieldId].text_en || '';
                    }
                }

            } catch (error) {
                console.error("Error loading content:", error);
                showToast("Gagal memuat konten website.", 'error');
            }
        };

        const renderBannersAdmin = async () => {
            adminDom.bannerList.innerHTML = '<p style="text-align:center;">Memuat banner...</p>';
            try {
                const snapshot = await db.collection('banners').orderBy('sort_order').get();
                const banners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                adminDom.bannerList.innerHTML = '';
                if (banners.length === 0) {
                    adminDom.bannerList.innerHTML = `<p style="grid-column: 1 / -1; text-align:center;">Tidak ada banner.</p>`;
                    return;
                }

                banners.forEach(b => {
                    const bannerDiv = document.createElement('div');
                    bannerDiv.className = 'dashboard-stat-card'; // Reuse style for card-like appearance
                    bannerDiv.style.textAlign = 'left';
                    bannerDiv.innerHTML = `
                        <img src="${b.image_url}" alt="Banner" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:15px;">
                        <p style="font-size:0.9em; word-break: break-all;"><strong>URL:</strong> ${b.image_url.substring(0, 50)}...</p>
                        <p style="font-size:0.9em;"><strong>Urutan:</strong> ${b.sort_order}</p>
                        <div class="action-buttons" style="margin-top:15px; text-align:right;">
                            <button title="Edit Banner" data-id="${b.id}" data-action="edit-banner"><i class="fas fa-edit"></i></button>
                            <button title="Hapus Banner" data-id="${b.id}" data-action="delete-banner"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    adminDom.bannerList.appendChild(bannerDiv);
                });
            } catch (error) {
                console.error("Error rendering banners:", error);
                showToast("Gagal memuat banner.", 'error');
                adminDom.bannerList.innerHTML = `<p style="grid-column: 1 / -1; text-align:center;">Gagal memuat banner.</p>`;
            }
        };

        const renderGalleryImagesAdmin = async () => {
            adminDom.galleryImageList.innerHTML = '<p style="grid-column: 1 / -1; text-align:center;">Memuat gambar galeri...</p>';
            try {
                const snapshot = await db.collection('gallery_images').orderBy('sort_order').get();
                const galleryImages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                adminDom.galleryImageList.innerHTML = '';
                if (galleryImages.length === 0) {
                    adminDom.galleryImageList.innerHTML = `<p style="grid-column: 1 / -1; text-align:center;">Tidak ada gambar galeri.</p>`;
                    return;
                }

                galleryImages.forEach(img => {
                    const imgDiv = document.createElement('div');
                    imgDiv.style.position = 'relative';
                    imgDiv.style.width = '100%';
                    imgDiv.style.paddingTop = '75%'; /* 4:3 Aspect Ratio */
                    imgDiv.style.overflow = 'hidden';
                    imgDiv.style.borderRadius = '8px';
                    imgDiv.style.boxShadow = 'var(--shadow-sm)';
                    imgDiv.style.backgroundColor = 'var(--color-surface)'; /* Ensure background for card effect */
                    imgDiv.innerHTML = `
                        <img src="${img.image_url}" alt="${img.caption_en}" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;">
                        <div class="action-buttons" style="position:absolute; bottom:5px; right:5px; background:rgba(255,255,255,0.8); padding:5px; border-radius:5px;">
                            <button title="Edit Gambar" data-id="${img.id}" data-action="edit-gallery-image" style="color:#2D4C5E;"><i class="fas fa-edit"></i></button>
                            <button title="Hapus Gambar" data-id="${img.id}" data-action="delete-gallery-image" style="color:#D84B42;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                         <p style="position:absolute; bottom:5px; left:5px; color:#fff; font-size:0.8em; text-shadow:1px 1px 3px rgba(0,0,0,0.7);">${(img.caption_id || img.caption_en || '').substring(0, 20)}...</p>
                    `;
                    adminDom.galleryImageList.appendChild(imgDiv);
                });
            } catch (error) {
                console.error("Error rendering gallery images:", error);
                showToast("Gagal memuat gambar galeri.", 'error');
                adminDom.galleryImageList.innerHTML = `<p style="grid-column: 1 / -1; text-align:center;">Gagal memuat gambar galeri.</p>`;
            }
        };

        const renderHistoryAdmin = async () => {
            adminDom.historyList.innerHTML = '<p style="text-align:center;">Memuat riwayat...</p>';
            try {
                const snapshot = await db.collection('history').orderBy('sort_order').get();
                const historyItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                adminDom.historyList.innerHTML = '';
                if (historyItems.length === 0) {
                    adminDom.historyList.innerHTML = `<p style="text-align:center;">Tidak ada item riwayat.</p>`;
                    return;
                }

                historyItems.forEach(item => {
                    const historyDiv = document.createElement('div');
                    historyDiv.className = 'content-section';
                    historyDiv.style.marginBottom = '15px';
                    historyDiv.innerHTML = `
                        <h3>${item.year} - ${item.title_id || item.title_en}</h3>
                        <p>${(item.text_id || item.text_en || '').substring(0, 150)}...</p>
                        <p style="font-size:0.9em; color:var(--color-text-light);"><strong>Urutan:</strong> ${item.sort_order}</p>
                        <div class="action-buttons" style="margin-top:10px; text-align:right;">
                            <button title="Edit Riwayat" data-id="${item.id}" data-action="edit-history"><i class="fas fa-edit"></i></button>
                            <button title="Hapus Riwayat" data-id="${item.id}" data-action="delete-history"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    adminDom.historyList.appendChild(historyDiv);
                });
            } catch (error) {
                console.error("Error rendering history:", error);
                showToast("Gagal memuat riwayat.", 'error');
                adminDom.historyList.innerHTML = `<p style="text-align:center;">Gagal memuat riwayat.</p>`;
            }
        };

        // --- Utility for Category Dropdown in Products ---
        const populateCategoryDropdown = () => {
            adminDom.productCategoryField.innerHTML = '<option value="">Pilih Kategori</option>';
            categoriesData.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id; // Use category ID as value
                option.textContent = cat.name;
                adminDom.productCategoryField.appendChild(option);
            });
        };

        // --- Setup All Event Listeners ---
        const setupEventListeners = () => {
            // Close Modals
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal-overlay'));
                });
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(overlay);
                    }
                });
            });

            // Product Actions
            adminDom.addProductBtn.addEventListener('click', () => openProductModal());
            adminDom.productsTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const productId = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'edit-product') {
                    openProductModal(productId);
                } else if (action === 'delete-product') {
                    if (confirm('Anda yakin ingin menghapus produk ini?')) {
                        deleteProduct(productId);
                    }
                }
            });

            // Category Actions
            adminDom.addCategoryBtn.addEventListener('click', () => openCategoryModal());
            adminDom.categoriesTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const categoryId = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'edit-category') {
                    openCategoryModal(categoryId);
                } else if (action === 'delete-category') {
                    if (confirm('Anda yakin ingin menghapus kategori ini? Ini akan memengaruhi produk terkait!')) {
                        deleteCategory(categoryId);
                    }
                }
            });

            // Order Actions
            adminDom.ordersTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const orderId = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'view') {
                    viewOrderDetails(orderId);
                } else if (action === 'status') {
                    updateOrderStatus(orderId);
                } else if (action === 'delete') {
                    if (confirm('Anda yakin ingin menghapus pesanan ini?')) {
                        deleteOrder(orderId);
                    }
                } else if (action === 'whatsapp') {
                    sendWhatsAppFollowUp(orderId);
                }
            });

            // Content Form Submission
            adminDom.contentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showToast("Menyimpan konten...", 'info');
                const btn = e.submitter;
                btn.disabled = true;

                try {
                    const contentFieldIds = [
                        'page_title', 'hero_title', 'hero_subtitle', 'footer_description', 'history_title',
                        'menu_section_subtitle', 'menu_title', 'full_menu_title', 'gallery_section_subtitle', 'gallery_title',
                        'footer_contact_title', 'footer_address_label', 'footer_address_value', 'footer_phone_label',
                        'footer_phone_value', 'footer_email_label', 'footer_email_value', 'footer_hours_label',
                        'footer_hours_value', 'footer_copyright', 'add_to_cart_btn', 'order_now_btn', 'modal_title',
                        'modal_name_label', 'modal_phone_label', 'modal_detect_location', 'modal_submit_button',
                        'cart_title', 'cart_subtotal', 'cart_delivery_fee', 'cart_total', 'cart_checkout_button', 'cart_continue_shopping'
                    ];

                    for (const fieldId of contentFieldIds) {
                        const idInput = document.getElementById(`content_${fieldId}_id`);
                        const enInput = document.getElementById(`content_${fieldId}_en`);

                        const updateData = {};
                        if (idInput) {
                            updateData.text_id = idInput.value;
                        }
                        if (enInput) {
                            updateData.text_en = enInput.value;
                        }

                        // Update Firestore document for each content key
                        await db.collection('content').doc(fieldId).set(updateData, { merge: true });
                    }
                    showToast("Konten berhasil diperbarui!", 'success');
                } catch (error) {
                    console.error("Error saving content:", error);
                    showToast("Gagal menyimpan konten: " + error.message, 'error');
                } finally {
                    btn.disabled = false;
                }
            });

            // Product Form Submission
            adminDom.productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.submitter;
                submitBtn.disabled = true;
                showToast("Menyimpan produk...", 'info');

                const productId = adminDom.productIdField.value;
                let imageUrl = adminDom.productImageUrlField.value;
                const imageFile = adminDom.productImageUploadField.files[0];

                try {
                    if (imageFile) {
                        const storageRef = storage.ref('products/' + Date.now() + '_' + imageFile.name);
                        const snapshot = await storageRef.put(imageFile);
                        imageUrl = await snapshot.ref.getDownloadURL();
                    } else if (!imageUrl && !productId) {
                         showToast("Mohon masukkan URL gambar atau unggah gambar.", 'error');
                         submitBtn.disabled = false;
                         return;
                    }

                    const selectedCategory = categoriesData.find(c => c.id === adminDom.productCategoryField.value);
                    if (!selectedCategory) {
                        showToast("Kategori tidak valid.", 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const productData = {
                        name_id: adminDom.productNameIdField.value,
                        name_en: adminDom.productNameEnField.value,
                        price: parseFloat(adminDom.productPriceField.value),
                        category_id: selectedCategory.id,
                        category_name: selectedCategory.name,
                        description_id: adminDom.productDescriptionIdField.value,
                        description_en: adminDom.productDescriptionEnField.value,
                        imageUrl: imageUrl,
                        is_featured: adminDom.productIsFeaturedField.checked,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (productId) {
                        await db.collection('products').doc(productId).update(productData);
                        showToast("Produk berhasil diperbarui!", 'success');
                    } else {
                        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('products').add(productData);
                        showToast("Produk berhasil ditambahkan!", 'success');
                    }
                    closeModal(adminDom.productModal);
                } catch (error) {
                    console.error("Error saving product:", error);
                    showToast("Gagal menyimpan produk: " + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // Product Image Preview
            adminDom.productImageUploadField.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        adminDom.productImagePreview.src = e.target.result;
                        adminDom.productImagePreview.style.display = 'block';
                        adminDom.productImageUrlField.value = ''; // Clear URL field if file uploaded
                    };
                    reader.readAsDataURL(file);
                } else {
                    adminDom.productImagePreview.style.display = 'none';
                    adminDom.productImagePreview.src = '';
                }
            });
            adminDom.productImageUrlField.addEventListener('input', function() {
                if (this.value) {
                    adminDom.productImagePreview.src = this.value;
                    adminDom.productImagePreview.style.display = 'block';
                    adminDom.productImageUploadField.value = ''; // Clear file input if URL entered
                } else {
                    adminDom.productImagePreview.style.display = 'none';
                    adminDom.productImagePreview.src = '';
                }
            });


            // Category Form Submission
            adminDom.categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.submitter;
                submitBtn.disabled = true;
                showToast("Menyimpan kategori...", 'info');

                const categoryId = adminDom.categoryIdField.value;
                const categoryName = adminDom.categoryNameField.value;

                try {
                    if (categoryId) {
                        await db.collection('categories').doc(categoryId).update({ name: categoryName });
                        showToast("Kategori berhasil diperbarui!", 'success');
                    } else {
                        const newDocRef = db.collection('categories').doc();
                        await newDocRef.set({
                            id: newDocRef.id,
                            name: categoryName,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast("Kategori berhasil ditambahkan!", 'success');
                    }
                    closeModal(adminDom.categoryModal);
                } catch (error) {
                    console.error("Error saving category:", error);
                    showToast("Gagal menyimpan kategori: " + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // Banner Actions
            adminDom.addBannerBtn.addEventListener('click', () => openBannerModal());
            adminDom.bannerList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const bannerId = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'edit-banner') {
                    openBannerModal(bannerId);
                } else if (action === 'delete-banner') {
                    if (confirm('Anda yakin ingin menghapus banner ini?')) {
                        deleteBanner(bannerId);
                    }
                }
            });

            // Banner Form Submission
            adminDom.bannerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.submitter;
                submitBtn.disabled = true;
                showToast("Menyimpan banner...", 'info');

                const bannerId = adminDom.bannerIdField.value;
                let imageUrl = adminDom.bannerImageUrlField.value;
                const imageFile = adminDom.bannerImageUploadField.files[0];
                const sortOrder = parseInt(adminDom.bannerSortOrderField.value);

                try {
                    if (imageFile) {
                        const storageRef = storage.ref('banners/' + Date.now() + '_' + imageFile.name);
                        const snapshot = await storageRef.put(imageFile);
                        imageUrl = await snapshot.ref.getDownloadURL();
                    } else if (!imageUrl && !bannerId) {
                         showToast("Mohon masukkan URL gambar atau unggah gambar.", 'error');
                         submitBtn.disabled = false;
                         return;
                    }

                    const bannerData = {
                        image_url: imageUrl,
                        sort_order: sortOrder,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (bannerId) {
                        await db.collection('banners').doc(bannerId).update(bannerData);
                        showToast("Banner berhasil diperbarui!", 'success');
                    } else {
                        bannerData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('banners').add(bannerData);
                        showToast("Banner berhasil ditambahkan!", 'success');
                    }
                    closeModal(adminDom.bannerModal);
                } catch (error) {
                    console.error("Error saving banner:", error);
                    showToast("Gagal menyimpan banner: " + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // Banner Image Preview
            adminDom.bannerImageUploadField.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        adminDom.bannerImagePreview.src = e.target.result;
                        adminDom.bannerImagePreview.style.display = 'block';
                        adminDom.bannerImageUrlField.value = '';
                    };
                    reader.readAsDataURL(file);
                } else {
                    adminDom.bannerImagePreview.style.display = 'none';
                    adminDom.bannerImagePreview.src = '';
                }
            });
            adminDom.bannerImageUrlField.addEventListener('input', function() {
                if (this.value) {
                    adminDom.bannerImagePreview.src = this.value;
                    adminDom.bannerImagePreview.style.display = 'block';
                    adminDom.bannerImageUploadField.value = '';
                } else {
                    adminDom.bannerImagePreview.style.display = 'none';
                    adminDom.bannerImagePreview.src = '';
                }
            });


            // Gallery Image Actions
            adminDom.addGalleryImageBtn.addEventListener('click', () => openGalleryImageModal());
            adminDom.galleryImageList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const imageId = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'edit-gallery-image') {
                    openGalleryImageModal(imageId);
                } else if (action === 'delete-gallery-image') {
                    if (confirm('Anda yakin ingin menghapus gambar galeri ini?')) {
                        deleteGalleryImage(imageId);
                    }
                }
            });

            // Gallery Image Form Submission
            adminDom.galleryImageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.submitter;
                submitBtn.disabled = true;
                showToast("Menyimpan gambar galeri...", 'info');

                const imageId = adminDom.galleryImageIdField.value;
                let imageUrl = adminDom.galleryImageUrlField.value;
                const imageFile = adminDom.galleryImageUploadField.files[0];
                const captionId = adminDom.galleryImageCaptionIdField.value;
                const captionEn = adminDom.galleryImageCaptionEnField.value;
                const sortOrder = parseInt(adminDom.galleryImageSortOrderField.value);

                try {
                    if (imageFile) {
                        const storageRef = storage.ref('gallery/' + Date.now() + '_' + imageFile.name);
                        const snapshot = await storageRef.put(imageFile);
                        imageUrl = await snapshot.ref.getDownloadURL();
                    } else if (!imageUrl && !imageId) {
                         showToast("Mohon masukkan URL gambar atau unggah gambar.", 'error');
                         submitBtn.disabled = false;
                         return;
                    }

                    const imageData = {
                        image_url: imageUrl,
                        caption_id: captionId,
                        caption_en: captionEn,
                        sort_order: sortOrder,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (imageId) {
                        await db.collection('gallery_images').doc(imageId).update(imageData);
                        showToast("Gambar galeri berhasil diperbarui!", 'success');
                    } else {
                        imageData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('gallery_images').add(imageData);
                        showToast("Gambar galeri berhasil ditambahkan!", 'success');
                    }
                    closeModal(adminDom.galleryImageModal);
                } catch (error) {
                    console.error("Error saving gallery image:", error);
                    showToast("Gagal menyimpan gambar galeri: " + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // Gallery Image Preview
            adminDom.galleryImageUploadField.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        adminDom.galleryImagePreview.src = e.target.result;
                        adminDom.galleryImagePreview.style.display = 'block';
                        adminDom.galleryImageUrlField.value = '';
                    };
                    reader.readAsDataURL(file);
                } else {
                    adminDom.galleryImagePreview.style.display = 'none';
                    adminDom.galleryImagePreview.src = '';
                }
            });
            adminDom.galleryImageUrlField.addEventListener('input', function() {
                if (this.value) {
                    adminDom.galleryImagePreview.src = this.value;
                    adminDom.galleryImagePreview.style.display = 'block';
                    adminDom.galleryImageUploadField.value = '';
                } else {
                    adminDom.galleryImagePreview.style.display = 'none';
                    adminDom.galleryImagePreview.src = '';
                }
            });


            // History Actions
            adminDom.addHistoryBtn.addEventListener('click', () => openHistoryModal());
            adminDom.historyList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const historyId = target.dataset.id;
                const action = target.dataset.action;

                if (action === 'edit-history') {
                    openHistoryModal(historyId);
                } else if (action === 'delete-history') {
                    if (confirm('Anda yakin ingin menghapus item riwayat ini?')) {
                        deleteHistory(historyId);
                    }
                }
            });

            // History Form Submission
            adminDom.historyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.submitter;
                submitBtn.disabled = true;
                showToast("Menyimpan riwayat...", 'info');

                const historyId = adminDom.historyIdField.value;
                const year = parseInt(adminDom.historyYearField.value);
                const titleId = adminDom.historyTitleIdField.value;
                const titleEn = adminDom.historyTitleEnField.value;
                const textId = adminDom.historyTextIdField.value;
                const textEn = adminDom.historyTextEnField.value;
                const sortOrder = parseInt(adminDom.historySortOrderField.value);

                try {
                    const historyData = {
                        year: year,
                        title_id: titleId,
                        title_en: titleEn,
                        text_id: textId,
                        text_en: textEn,
                        sort_order: sortOrder,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (historyId) {
                        await db.collection('history').doc(historyId).update(historyData);
                        showToast("Riwayat berhasil diperbarui!", 'success');
                    } else {
                        historyData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('history').add(historyData);
                        showToast("Riwayat berhasil ditambahkan!", 'success');
                    }
                    closeModal(adminDom.historyModal);
                } catch (error) {
                    console.error("Error saving history item:", error);
                    showToast("Gagal menyimpan riwayat: " + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // Admin Profile Form Submission
            adminDom.adminProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.submitter;
                submitBtn.disabled = true;
                showToast("Memperbarui profil...", 'info');

                try {
                    await db.collection('admins').doc(auth.currentUser.uid).update({
                        name: adminDom.adminNameField.value,
                        phone: adminDom.adminPhoneField.value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Profil berhasil diperbarui!", 'success');
                    adminData.name = adminDom.adminNameField.value; // Update local cache
                    adminData.phone = adminDom.adminPhoneField.value;
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showToast("Gagal memperbarui profil: " + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });
        };

        // --- Modals Logic Implementation ---

        const openProductModal = async (productId = null) => {
            adminDom.productForm.reset();
            adminDom.productIdField.value = '';
            adminDom.productImagePreview.style.display = 'none';
            adminDom.productImagePreview.src = '';
            adminDom.productImageUrlField.value = ''; // Clear URL field
            adminDom.productImageUploadField.value = ''; // Clear file input
            adminDom.productModalTitle.textContent = productId ? 'Edit Produk' : 'Tambah Produk Baru';

            populateCategoryDropdown(); // Pastikan dropdown kategori terbaru

            if (productId) {
                try {
                    const doc = await db.collection('products').doc(productId).get();
                    if (doc.exists) {
                        const product = doc.data();
                        adminDom.productIdField.value = doc.id;
                        adminDom.productNameIdField.value = product.name_id || '';
                        adminDom.productNameEnField.value = product.name_en || '';
                        adminDom.productPriceField.value = product.price || 0;
                        adminDom.productCategoryField.value = product.category_id || ''; // Select based on ID
                        adminDom.productDescriptionIdField.value = product.description_id || '';
                        adminDom.productDescriptionEnField.value = product.description_en || '';
                        adminDom.productImageUrlField.value = product.imageUrl || '';
                        adminDom.productImagePreview.src = product.imageUrl || '';
                        adminDom.productImagePreview.style.display = product.imageUrl ? 'block' : 'none';
                        adminDom.productIsFeaturedField.checked = product.is_featured || false;
                    }
                } catch (error) {
                    console.error("Error loading product for edit:", error);
                    showToast("Gagal memuat detail produk.", 'error');
                }
            }
            openModal(adminDom.productModal);
        };

        const deleteProduct = async (productId) => {
            showToast("Menghapus produk...", 'info');
            try {
                await db.collection('products').doc(productId).delete();
                showToast("Produk berhasil dihapus!", 'success');
                // Realtime listener akan me-render ulang
            } catch (error) {
                console.error("Error deleting product:", error);
                showToast("Gagal menghapus produk: " + error.message, 'error');
            }
        };

        const openCategoryModal = async (categoryId = null) => {
            adminDom.categoryForm.reset();
            adminDom.categoryIdField.value = '';
            adminDom.categoryNameField.value = '';
            adminDom.categoryModalTitle.textContent = categoryId ? 'Edit Kategori' : 'Tambah Kategori Baru';

            if (categoryId) {
                try {
                    const doc = await db.collection('categories').doc(categoryId).get();
                    if (doc.exists) {
                        const category = doc.data();
                        adminDom.categoryIdField.value = doc.id;
                        adminDom.categoryNameField.value = category.name || '';
                    }
                } catch (error) {
                    console.error("Error loading category for edit:", error);
                    showToast("Gagal memuat detail kategori.", 'error');
                }
            }
            openModal(adminDom.categoryModal);
        };

        const deleteCategory = async (categoryId) => {
            showToast("Menghapus kategori...", 'info');
            try {
                const productsUsingCategory = await db.collection('products').where('category_id', '==', categoryId).get();
                if (!productsUsingCategory.empty) {
                    const confirmation = confirm('Ada produk yang masih menggunakan kategori ini. Apakah Anda yakin ingin menghapus kategori dan menghapus tautan kategori dari produk-produk tersebut?');
                    if (!confirmation) {
                        showToast("Penghapusan kategori dibatalkan.", 'info');
                        return;
                    }
                    const batch = db.batch();
                    productsUsingCategory.docs.forEach(doc => {
                        batch.update(doc.ref, { category_id: null, category_name: 'Uncategorized' });
                    });
                    await batch.commit();
                    showToast("Produk terkait diperbarui.", 'info');
                }

                await db.collection('categories').doc(categoryId).delete();
                showToast("Kategori berhasil dihapus!", 'success');
                // Realtime listener akan me-render ulang
            } catch (error) {
                console.error("Error deleting category:", error);
                showToast("Gagal menghapus kategori: " + error.message, 'error');
            }
        };


        const viewOrderDetails = async (orderId) => {
            try {
                const doc = await db.collection('orders').doc(orderId).get();
                if (doc.exists) {
                    const order = doc.data();
                    let detailsHtml = `
                        <h3>Detail Pesanan #${orderId.substring(0, 6)}</h3>
                        <p><strong>Nama:</strong> ${order.customerName || 'N/A'}</p>
                        <p><strong>Telepon:</strong> ${order.customerPhone || 'N/A'}</p>
                        <p><strong>Alamat:</strong> ${order.customerAddress || 'N/A'}</p>
                        <p><strong>Waktu Pesan:</strong> ${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${order.status}">${order.status ? (order.status.charAt(0).toUpperCase() + order.status.slice(1)) : 'N/A'}</span></p>
                        <hr style="margin: 15px 0; border-top: 1px dashed var(--color-border);">
                        <h4>Item Pesanan:</h4>
                        <ul>
                    `;
                    order.orderDetails.forEach(item => {
                        detailsHtml += `<li>${item.quantity}x ${item.name} - Rp ${new Intl.NumberFormat('id-ID').format(item.price * item.quantity)}</li>`;
                    });
                    detailsHtml += `
                        </ul>
                        <hr style="margin: 15px 0; border-top: 1px dashed var(--color-border);">
                        <p><strong>Subtotal:</strong> Rp ${new Intl.NumberFormat('id-ID').format(order.subtotal || 0)}</p>
                        <p><strong>Biaya Pengiriman:</strong> Rp ${new Intl.NumberFormat('id-ID').format(order.deliveryFee || 0)}</p>
                        <p><strong>Total Pembayaran:</strong> Rp ${new Intl.NumberFormat('id-ID').format(order.totalAmount || 0)}</p>
                    `;

                    // Use a simple prompt/alert for demonstration in this single file.
                    // In a real app, you'd have a dedicated modal for this.
                    alert(detailsHtml.replace(/<hr[^>]*>/g, '\n').replace(/<[^>]*>/g, '').replace(/\n\s*\n/g, '\n').trim());
                } else {
                    showToast("Pesanan tidak ditemukan.", 'error');
                }
            } catch (error) {
                console.error("Error viewing order details:", error);
                showToast("Gagal memuat detail pesanan.", 'error');
            }
        };

        const updateOrderStatus = async (orderId) => {
            const currentOrderDoc = await db.collection('orders').doc(orderId).get();
            const currentStatus = currentOrderDoc.exists ? currentOrderDoc.data().status : 'new';
            const newStatus = prompt(`Masukkan status baru untuk pesanan #${orderId.substring(0, 6)} (saat ini: ${currentStatus}). Pilihan: new, processing, completed, cancelled:`, currentStatus);
            
            if (newStatus && ['new', 'processing', 'completed', 'cancelled'].includes(newStatus.toLowerCase())) {
                showToast("Memperbarui status pesanan...", 'info');
                try {
                    await db.collection('orders').doc(orderId).update({
                        status: newStatus.toLowerCase(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Status pesanan berhasil diperbarui!", 'success');
                } catch (error) {
                    console.error("Error updating order status:", error);
                    showToast("Gagal memperbarui status: " + error.message, 'error');
                }
            } else if (newStatus !== null) { // If user typed something but it's invalid
                showToast("Status tidak valid. Pilihan: new, processing, completed, cancelled.", 'error');
            }
        };

        const deleteOrder = async (orderId) => {
            showToast("Menghapus pesanan...", 'info');
            try {
                await db.collection('orders').doc(orderId).delete();
                showToast("Pesanan berhasil dihapus!", 'success');
            } catch (error) {
                console.error("Error deleting order:", error);
                showToast("Gagal menghapus pesanan: " + error.message, 'error');
            }
        };

        const sendWhatsAppFollowUp = async (orderId) => {
            try {
                const doc = await db.collection('orders').doc(orderId).get();
                if (doc.exists) {
                    const order = doc.data();
                    const phoneNumber = order.customerPhone.replace(/\D/g, ''); // Hapus non-digit
                    
                    let message = `Halo ${order.customerName || 'pelanggan'},\n\n`;
                    message += `Kami dari Lobster Shack Bali ingin memberitahukan bahwa status pesanan Anda (ID: #${orderId.substring(0,6)}) saat ini adalah *${(order.status || 'N/A').toUpperCase()}*.\n\n`;
                    message += `Detail Pesanan:\n`;
                    order.orderDetails.forEach(item => {
                        message += `- ${item.quantity}x ${item.name} (Rp ${new Intl.NumberFormat('id-ID').format(item.price * item.quantity)})\n`;
                    });
                    message += `\nTotal Pembayaran: Rp ${new Intl.NumberFormat('id-ID').format(order.totalAmount || 0)}\n`;
                    message += `Alamat Pengiriman: ${order.customerAddress || 'N/A'}\n\n`;
                    message += `Terima kasih telah berbelanja di Lobster Shack Bali! `;

                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    showToast("Membuka WhatsApp untuk follow up.", 'info');
                } else {
                    showToast("Pesanan tidak ditemukan untuk follow up.", 'error');
                }
            } catch (error) {
                console.error("Error sending WhatsApp follow-up:", error);
                showToast("Gagal mengirim follow up WhatsApp.", 'error');
            }
        };

        const openBannerModal = async (bannerId = null) => {
            adminDom.bannerForm.reset();
            adminDom.bannerIdField.value = '';
            adminDom.bannerImagePreview.style.display = 'none';
            adminDom.bannerImagePreview.src = '';
            adminDom.bannerImageUrlField.value = '';
            adminDom.bannerImageUploadField.value = '';
            adminDom.bannerSortOrderField.value = 0;
            adminDom.bannerModalTitle.textContent = bannerId ? 'Edit Banner' : 'Tambah Banner Baru';

            if (bannerId) {
                try {
                    const doc = await db.collection('banners').doc(bannerId).get();
                    if (doc.exists) {
                        const banner = doc.data();
                        adminDom.bannerIdField.value = doc.id;
                        adminDom.bannerImageUrlField.value = banner.image_url || '';
                        adminDom.bannerImagePreview.src = banner.image_url || '';
                        adminDom.bannerImagePreview.style.display = banner.image_url ? 'block' : 'none';
                        adminDom.bannerSortOrderField.value = banner.sort_order || 0;
                    }
                } catch (error) {
                    console.error("Error loading banner for edit:", error);
                    showToast("Gagal memuat detail banner.", 'error');
                }
            }
            openModal(adminDom.bannerModal);
        };

        const deleteBanner = async (bannerId) => {
            showToast("Menghapus banner...", 'info');
            try {
                await db.collection('banners').doc(bannerId).delete();
                showToast("Banner berhasil dihapus!", 'success');
            } catch (error) {
                console.error("Error deleting banner:", error);
                showToast("Gagal menghapus banner: " + error.message, 'error');
            }
        };

        const openGalleryImageModal = async (imageId = null) => {
            adminDom.galleryImageForm.reset();
            adminDom.galleryImageIdField.value = '';
            adminDom.galleryImagePreview.style.display = 'none';
            adminDom.galleryImagePreview.src = '';
            adminDom.galleryImageUrlField.value = '';
            adminDom.galleryImageUploadField.value = '';
            adminDom.galleryImageCaptionIdField.value = '';
            adminDom.galleryImageCaptionEnField.value = '';
            adminDom.galleryImageSortOrderField.value = 0;
            adminDom.galleryImageModalTitle.textContent = imageId ? 'Edit Gambar Galeri' : 'Tambah Gambar Galeri Baru';

            if (imageId) {
                try {
                    const doc = await db.collection('gallery_images').doc(imageId).get();
                    if (doc.exists) {
                        const image = doc.data();
                        adminDom.galleryImageIdField.value = doc.id;
                        adminDom.galleryImageUrlField.value = image.image_url || '';
                        adminDom.galleryImagePreview.src = image.image_url || '';
                        adminDom.galleryImagePreview.style.display = image.image_url ? 'block' : 'none';
                        adminDom.galleryImageCaptionIdField.value = image.caption_id || '';
                        adminDom.galleryImageCaptionEnField.value = image.caption_en || '';
                        adminDom.galleryImageSortOrderField.value = image.sort_order || 0;
                    }
                } catch (error) {
                    console.error("Error loading gallery image for edit:", error);
                    showToast("Gagal memuat detail gambar galeri.", 'error');
                }
            }
            openModal(adminDom.galleryImageModal);
        };

        const deleteGalleryImage = async (imageId) => {
            showToast("Menghapus gambar galeri...", 'info');
            try {
                await db.collection('gallery_images').doc(imageId).delete();
                showToast("Gambar galeri berhasil dihapus!", 'success');
            } catch (error) {
                console.error("Error deleting gallery image:", error);
                showToast("Gagal menghapus gambar galeri: " + error.message, 'error');
            }
        };

        const openHistoryModal = async (historyId = null) => {
            adminDom.historyForm.reset();
            adminDom.historyIdField.value = '';
            adminDom.historyYearField.value = new Date().getFullYear(); // Default to current year
            adminDom.historyTitleIdField.value = '';
            adminDom.historyTitleEnField.value = '';
            adminDom.historyTextIdField.value = '';
            adminDom.historyTextEnField.value = '';
            adminDom.historySortOrderField.value = 0;
            adminDom.historyModalTitle.textContent = historyId ? 'Edit Item Riwayat' : 'Tambah Item Riwayat Baru';

            if (historyId) {
                try {
                    const doc = await db.collection('history').doc(historyId).get();
                    if (doc.exists) {
                        const item = doc.data();
                        adminDom.historyIdField.value = doc.id;
                        adminDom.historyYearField.value = item.year || '';
                        adminDom.historyTitleIdField.value = item.title_id || '';
                        adminDom.historyTitleEnField.value = item.title_en || '';
                        adminDom.historyTextIdField.value = item.text_id || '';
                        adminDom.historyTextEnField.value = item.text_en || '';
                        adminDom.historySortOrderField.value = item.sort_order || 0;
                    }
                } catch (error) {
                    console.error("Error loading history item for edit:", error);
                    showToast("Gagal memuat detail riwayat.", 'error');
                }
            }
            openModal(adminDom.historyModal);
        };

        const deleteHistory = async (historyId) => {
            showToast("Menghapus item riwayat...", 'info');
            try {
                await db.collection('history').doc(historyId).delete();
                showToast("Item riwayat berhasil dihapus!", 'success');
            } catch (error) {
                console.error("Error deleting history item:", error);
                showToast("Gagal menghapus riwayat: " + error.message, 'error');
            }
        };

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // No need to call initializeAdminPanel here, it's called after auth check
            // The initial state (login page or admin panel) is handled by auth.onAuthStateChanged
        });
    </script>
</body>
</html>
